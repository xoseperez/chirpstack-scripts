# The Things Stack (TTN/TTI) to ChirpStack Device Exporter

Two-stage script to export devices from a The Things Stack server (TTN/TTI) to a ChirpStack server. Devices are exported with root and session keys from an application in TTS to an application is ChirpStack so they will work on the new server without changes (without joining in again).

## Usage

Recommended usage is via virtualenv. A convenient Makefile is included to easily create and run the scripts inside a virtual python environment. If you prefer you can also do it manually:

```
pip install virtualenv
virtualenv .venv
source .venv/bin/activate
pip install -Ur requirements.txt
deactivate
```

The lines above will create the environment and install the required packages. Then, to run the scripts you will have to:

```
source .venv/bin/activate
python cs_importer.py
deactivate
```

Steps to export devices from a TTS application into a ChirpStack application.

1) Copy the `config.example.yml` file into `config.yml` and edit it to match your requirements.
1) Run the export script and provide missing information. The script will generate a CSV file under the `export` folder with all the devices exported.
1) Run the import script and provide missing information and the CSV generated by the import script.

## Export

```
> python tts_exporter.py --help
usage: tts_exporter.py [-h] [--application-id THETHINGSSTACK_APPLICATION_ID] [--appkey THETHINGSSTACK_APPKEY] [--active-since THETHINGSSTACK_ACTIVE_SINCE] [-y]

options:
  -h, --help            Show this help message and exit
  --application-id      THETHINGSSTACK_APPLICATION_ID
                        Application ID
  --appkey              THETHINGSSTACK_APPKEY
                        App Key to login
  --active-since        THETHINGSSTACK_ACTIVE_SINCE
                        Active in the last X seconds (also time units or fixed datetime allowed)
  -y                    Skip interactive promt

```

The export script uses `ttn-lw-cli` in the background. If you don't have it installed you have to follow the instructions here: https://www.thethingsindustries.com/docs/the-things-stack/interact/cli/installing-cli/.

You can provide the configuration for both the exporter and importer in 3 different ways:

* the `config.yml` file
* via command line arguments (check the help output above)
* via environment variables (check the uppercase keys in the help output above)

For instance, in your `config.yml` file you can have something like:

```
thethingsstack:
  application_id: 'xp-airquality'
```

This will by default export the devices in the `xp-airquality` application. You can do the same by running:

```
python tts_exporter.py --application-id xp-airquality
```

or

```
THETHINGSSTACK_APPLICATION_ID=xp-airquality python tts_exporter.py
```

Please note the export procedure is **slow**. You can filter the devices you want to export by prividing an `active since` value to output only those devices that have reported in the last X minutes/hours. The recommended approach is to do a first export with all devices, import them and then do incremental export/imports with only the recent updated devices before enabling ChirpStack as the main server.

```
python tts_exporter.py --application-id xp-airquality --active-since 1h
```

For a complete unattended export, provide a personal `apikey` with the `View devices in application` right and the run the script with the `-y` argument to skip the interactive prompt.

## Import

```
> python cs_importer.py -h
usage: cs_importer.py [-h] [--server CHIRPSTACK_SERVER] [--api-token CHIRPSTACK_API_TOKEN] [--application-id CHIRPSTACK_APPLICATION_ID] [--device-profile-id CHIRPSTACK_DEVICE_PROFILE_ID] [--filename FILENAME]
                   [-y]

options:
  -h, --help            show this help message and exit
  --server              CHIRPSTACK_SERVER
                        Chirpstack server (ip/domain and port)
  --api-token           CHIRPSTACK_API_TOKEN
                        API token with permissions on the application
  --application-id      CHIRPSTACK_APPLICATION_ID
                        Application EUI to save the devices to
  --device-profile-id   CHIRPSTACK_DEVICE_PROFILE_ID
                        Device profile EUI to use when creating the devices
  --filename            FILENAME
                        File with the data to import
  -y                    Skip interactive promt
  ```

  The import script uses ChirpStack RPC API and can be configured in the same was as the export script (`config.yml`, command line arguments or environment variables).

  You will first have to create an application and a device profile for the devices (all created devices will use the same device profile). The EUI for both the application and the device profile can be found under their names in the main pages.

  The script expects a CSV file in the same format as the export script creates.

  Importing devices to a local ChirpStack instance from a CSV is about 10x faster than exporting from TTN.